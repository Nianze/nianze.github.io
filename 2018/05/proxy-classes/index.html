<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="ÂàÄÂøÉ„ÅÆÊ∞¥">
<meta name="keywords" content=", visual, music, technology">
<meta name="description" content="Objects that stand for other objects are often called proxy objects (or surrogates), and the classes that give rise to proxy objects are often called proxy classes, which is useful for implementing multidimensional arrays, differentiating lvalue/rvalue, and suppressing implicit conversions.">


<meta property="og:description" content="Objects that stand for other objects are often called proxy objects (or surrogates), and the classes that give rise to proxy objects are often called proxy classes, which is useful for implementing multidimensional arrays, differentiating lvalue/rvalue, and suppressing implicit conversions.">
<meta property="og:type" content="article">
<meta property="og:title" content="[MECpp]Item-30 Proxy Classes">
<meta name="twitter:title" content="[MECpp]Item-30 Proxy Classes">
<meta property="og:url" content="https://nianze.tk/2018/05/proxy-classes/">
<meta property="twitter:url" content="https://nianze.tk/2018/05/proxy-classes/">
<meta property="og:site_name" content="Be creative">
<meta property="og:description" content="Objects that stand for other objects are often called proxy objects (or surrogates), and the classes that give rise to proxy objects are often called proxy classes, which is useful for implementing multidimensional arrays, differentiating lvalue/rvalue, and suppressing implicit conversions.">
<meta name="twitter:description" content="Objects that stand for other objects are often called proxy objects (or surrogates), and the classes that give rise to proxy objects are often called proxy classes, which is useful for implementing multidimensional arrays, differentiating lvalue/rvalue, and suppressing implicit conversions.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2018-05-09T00:00:00">
  
  
    <meta property="article:modified_time" content="2018-05-09T00:00:00">
  
  
  
    
      <meta property="article:section" content="technology">
    
      <meta property="article:section" content="coding">
    
  
  
    
      <meta property="article:tag" content="technique">
    
      <meta property="article:tag" content="cpp">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://nianze.tk/images/2018/2018-05/2018-05-09.gif">
  <meta property="twitter:image" content="https://nianze.tk/images/2018/2018-05/2018-05-09.gif">





  <meta property="og:image" content="https://nianze.tk/images/bw.JPG">
  <meta property="twitter:image" content="https://nianze.tk/images/bw.JPG">


    <title>[MECpp]Item-30 Proxy Classes</title>

    <link rel="icon" href="https://nianze.tk/favicon.png">
    

    

    <link rel="canonical" href="https://nianze.tk/2018/05/proxy-classes/">

    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://nianze.tk/css/style-nnm2spxvve8onlujjlegkkytaehyadd4ksxc1hyzzq9a2wvtrgbljqyulomn.min.css" />
    
    
      
        <link rel="stylesheet" href="https://nianze.tk/css/main.css">
      
    
      
        <link rel="stylesheet" href="https://nianze.tk/css/loader.css">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-71584380-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body id="container">
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fas fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://nianze.tk/">Be creative</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://nianze.tk/#about">
    
    
    
      
        <img class="header-picture" src="https://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://nianze.tk/#about">
          <img class="sidebar-profile-picture" src="https://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">ÂàÄÂøÉ„ÅÆÊ∞¥</h4>
        
          <h5 class="sidebar-profile-bio"><p>ËôöÂ∫¶Âªø‰ΩôÂ≤ÅÊúàÊµÖÔºåÁï•ËØÜÂá†Ë°å‰ª£Á†ÅÊ∫ê„ÄÇ<br />
Èó≤Êù•ÈöèÊâãÂø´Èó®ÊåâÔºåÊÄÜÁÑ∂Áã¨ÊääÈü≥ÈüµÂºπ„ÄÇ</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/">
    
      <i class="sidebar-button-icon fas fa-home" title='Home'></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/categories/thoughts">
    
      <i class="sidebar-button-icon fas fa-lightbulb" title='Thoughts'></i>
      
      <span class="sidebar-button-desc">Thoughts</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/categories/technology">
    
      <i class="sidebar-button-icon fas fa-code" title='Technology'></i>
      
      <span class="sidebar-button-desc">Technology</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/categories/music">
    
      <i class="sidebar-button-icon fas fa-music" title='Music'></i>
      
      <span class="sidebar-button-desc">Music</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/categories/visual">
    
      <i class="sidebar-button-icon fas fa-palette" title='Visual'></i>
      
      <span class="sidebar-button-desc">Visual</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/categories">
    
      <i class="sidebar-button-icon fas fa-bookmark" title='Categories'></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/tags">
    
      <i class="sidebar-button-icon fas fa-tags" title='Tags'></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/archives">
    
      <i class="sidebar-button-icon fas fa-archive" title='Archives'></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/about">
    
      <i class="sidebar-button-icon fas fa-user" title='About'></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-linkedin" title='LinkedIn'></i>
      
      <span class="sidebar-button-desc">LinkedIn</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/Nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-github" title='Github'></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.flickr.com/photos/129774362@N07/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-flickr", title='Flickr'></i>
      
      <span class="sidebar-button-desc">Flickr</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://instagram.com/eznain" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-instagram" title='Instagram'></i>
      
      <span class="sidebar-button-desc">Instagram</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.facebook.com/rym.lnz" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-facebook", title='Facebook'></i>
      
      <span class="sidebar-button-desc">Facebook</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-twitter", title='Twitter'></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.youtube.com/user/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-youtube", title='YouTube'></i>
      
      <span class="sidebar-button-desc">YouTube</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="mailto:daoxinzhishui@gmail.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fas fa-envelope", title='Email'></i>
      
      <span class="sidebar-button-desc">Email</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://nianze.tk/post/index.xml">
    
      <i class="sidebar-button-icon fas fa-rss-square", title='RSS'></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      [MECpp]Item-30 Proxy Classes
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-05-09T00:00:00Z">
        
  May 9, 2018

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="https://nianze.tk/categories/technology">technology</a>, 
    
      <a class="category-link" href="https://nianze.tk/categories/coding">coding</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Objects that stand for other objects are often called <em>proxy objects</em> (or <em>surrogates</em>), and the classes that give rise to proxy objects are often called <em>proxy classes</em>, which is useful for implementing multidimensional arrays, differentiating lvalue/rvalue, and suppressing implicit conversions.</p>

<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
<ul>
<li><a href="#implementing-two-dimensional-arrays">Implementing Two-Dimensional Arrays</a></li>
<li><a href="#distinguishing-reads-from-writes-via-operator">Distinguishing Reads from Writes via operator[]</a>
<ul>
<li><a href="#for-rvalue-usage">For rvalue usage</a></li>
<li><a href="#for-lvalue-usage">For lvalue usage</a></li>
</ul></li>
<li><a href="#preventing-implicit-conversions-in-single-argument-constructor">Preventing implicit conversions in single-argument constructor</a></li>
<li><a href="#limitations">Limitations</a></li>
</ul>
</nav>

<h1 id="implementing-two-dimensional-arrays">Implementing Two-Dimensional Arrays</h1>

<p>Consider this statement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> data[<span style="color:#ae81ff">10</span>][<span style="color:#ae81ff">20</span>];
...
cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> data[<span style="color:#ae81ff">3</span>][<span style="color:#ae81ff">6</span>]; <span style="color:#75715e">// fine
</span></code></pre></div>
<p>We want to create a general 2D array supporting operations such as <code>data[3][6]</code>. However, there&rsquo;s no such thing as a <code>operator[][]</code> in C++. The reason it is legal to write code above that appears to use <code>operator[][]</code> is because the variable <code>data</code> is not really a two-dimensinal array at all, but a 10-element one-dimensional array, each element of which is itself a 20-element array. So the expression <code>data[3][6]</code> really means <code>(data[3])[6]</code> - the seventh element of the array that is the fourth element of <code>data</code>.</p>

<p>Playing the same trick as above, we can define our <code>Array2D</code> class by overloading <code>operator[]</code> to return an object of a new class, <code>Array1D</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Array2D</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Array1D</span> {
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        T<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index);
        <span style="color:#66d9ef">const</span> T<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index) <span style="color:#66d9ef">const</span>;
    };

    Array1D <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index);
    <span style="color:#66d9ef">const</span> Array1D <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index) <span style="color:#66d9ef">const</span>;
    ...
};
</code></pre></div>
<p>Then it is legal to write code like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Array2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> data(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>);
...
cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> data[<span style="color:#ae81ff">3</span>][<span style="color:#ae81ff">6</span>];
</code></pre></div>
<p>Conceptually intances of <code>Array1D</code> class (which is a <em>proxy class</em>) do not exist for clients of <code>Array2D</code>. Such clients program as if they were using real, live two-dimensional arrays.</p>

<h1 id="distinguishing-reads-from-writes-via-operator">Distinguishing Reads from Writes via operator[]</h1>

<p><code>operator[]</code> can be called in two different contexts:</p>

<ol>
<li><em>rvalue</em> usage for read</li>
<li><em>lvalue</em> usage for write</li>
</ol>

<p>In general, using an object as an lvalue means using it such that it might be modified, and using it as rvalue means using it such that it cannot be modified.</p>

<p>From MECpp item 29 reference counting, we can see reads can be much less expensive than writes - writes of reference-counted object may involve copying an entire data structure, while reads never require more than the simple returning of a value - so it will save a lot to differentiate lvalue usage from rvalue usage. However, it is impossible to tell whether <code>operator[]</code> is beeing invoked in an lvalue or an rvalue context from within <code>operator[]</code> - <code>operator[]</code> alone does not have the ability to determine the calling context.</p>

<p>The solution: we <em>delay</em> our lvalue-vs-rvalue actions until we see how the result of <code>operator[]</code> is used - by using proxy class to postpone our decision until <em>after</em> <code>operator[]</code> has returned (lazy evaluation, see MECpp item 7):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">String</span> {   <span style="color:#75715e">// reference-counted strings
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CharProxy</span> {   <span style="color:#75715e">// proxy fro string chars
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        CharProxy(String<span style="color:#f92672">&amp;</span> str, <span style="color:#66d9ef">int</span> index);  <span style="color:#75715e">// creation
</span><span style="color:#75715e"></span>        CharProxy<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">=</span>(<span style="color:#66d9ef">const</span> CharProxy<span style="color:#f92672">&amp;</span> rhs); <span style="color:#75715e">// lvalue uses
</span><span style="color:#75715e"></span>        CharProxy<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">=</span>(<span style="color:#66d9ef">char</span> c);  <span style="color:#75715e">// lvalue uses
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">operator</span> <span style="color:#a6e22e">char</span>() <span style="color:#66d9ef">const</span>; <span style="color:#75715e">// rvalue uses
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
        String<span style="color:#f92672">&amp;</span> theString;  <span style="color:#75715e">// string this proxy pertains to        
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> charIndex;  <span style="color:#75715e">// char within that string this proxy stands for
</span><span style="color:#75715e"></span>    };

    <span style="color:#66d9ef">const</span> CharProxy <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index) <span style="color:#66d9ef">const</span>; <span style="color:#75715e">// for const Strings
</span><span style="color:#75715e"></span>    CharProxy <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index);  <span style="color:#75715e">// for non-const Strings
</span><span style="color:#75715e"></span>    ...
    <span style="color:#66d9ef">friend</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CharProxy</span>; <span style="color:#75715e">// CharProxy need access to private data member: value
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    RCPtr<span style="color:#f92672">&lt;</span>StringValue<span style="color:#f92672">&gt;</span> value;
};
</code></pre></div>
<p>Now let&rsquo;s see how it works. Given reference-counted stirngs using proxies above <code>String s1, s2;</code>,</p>

<h2 id="for-rvalue-usage">For rvalue usage</h2>

<p>Consider this statement <code>cout &lt;&lt; s1[5];</code>: <code>s1[5]</code> yields a <code>CharProxy</code> object, and compiler implicitly converts this <code>CharProxy</code> into <code>char</code> using the conversion operator declared in the <code>CharProxy</code> class. This is representitive of the <em>CharProxy-to-char</em> conversion that takes place for all <code>CharProxy</code> objects used as rvalues.</p>

<h2 id="for-lvalue-usage">For lvalue usage</h2>

<p>Lvalue usage is handled differently:</p>

<p>Say, for statement <code>s2[5] = 'x';</code>, the expression <code>s2[5]</code> yields a <code>CharProxy</code> object, which is the target of an assignment, so the assignment operator in the <code>CharProxy</code> class will be called - this is the crucial postponed step to differentiate writes from reads. Inside this <code>CharProxy</code> assignment operator, we know the string character for which the proxy stands is being used as an lvalue.</p>

<p>Similarly, the statement <code>s1[3] = s2[7];</code> calls the assignment operator for two <code>CharProxy</code> objects, and inside the operator, we know the object on the left is being used as an lvalue and the object on the right as an rvalue.</p>

<p>Now that we know exactly the context in which caller invokes the <code>operator[]</code>, it is easy to implement them:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">const</span> String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy String<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index) <span style="color:#66d9ef">const</span>
{
    <span style="color:#75715e">// return a const proxy
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Because CharProxy::operator= isn&#39;t a const member function,
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the returned proxies can&#39;t be used as the target of assignment, and this behavior is exactly what we want for const version of operator[]
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">CharProxy</span>(<span style="color:#66d9ef">const_cast</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&amp;</span><span style="color:#f92672">&gt;</span>(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>), index);
}

String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy String<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index)
{
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">CharProxy</span>(<span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>, index);
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy(String<span style="color:#f92672">&amp;</span> str, <span style="color:#66d9ef">int</span> index)
<span style="color:#f92672">:</span> theString(str), charIndex(index) {}

String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">operator</span> <span style="color:#66d9ef">char</span>() <span style="color:#66d9ef">const</span>
{
    <span style="color:#66d9ef">return</span> theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[charIndex];
}

String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">&amp;</span> String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">=</span>(<span style="color:#66d9ef">const</span> CharProxy<span style="color:#f92672">&amp;</span> rhs)
{
    <span style="color:#66d9ef">if</span> (theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isShared())
    {
        theString.value <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringValue(theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data);
    }
    theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[charIndex] <span style="color:#f92672">=</span> 
        rhs.theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[charIndex];
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
}

String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">&amp;</span> String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">=</span>(<span style="color:#66d9ef">char</span> c)
{
    <span style="color:#66d9ef">if</span> (theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isShared())
    {
        theString.value <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringValue(theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data);
    }
    theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[charIndex] <span style="color:#f92672">=</span> c;
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>;
}
</code></pre></div>
<h1 id="preventing-implicit-conversions-in-single-argument-constructor">Preventing implicit conversions in single-argument constructor</h1>

<p>Refer to MECpp item 5.</p>

<h1 id="limitations">Limitations</h1>

<ol>
<li><p>Taking the address</p>

<p>In general, taking the address of a proxy yields a different type of pointer than does taking the address of a real object. Thus, the statement <code>char *p = &amp;s1[1];</code> will cause error. To eliminate the problem, we&rsquo;ll have to overload the address-of operators for <code>CharProxy</code> class:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">String</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    ...
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CharProxy</span> {
        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">&amp;</span>();
        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">&amp;</span>() <span style="color:#66d9ef">const</span>;
        ...
    };
    ...
};
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&amp;</span>()
{
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>(theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[charIndex]);
}
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> String<span style="color:#f92672">:</span><span style="color:#f92672">:</span>CharProxy<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&amp;</span>()
{
    <span style="color:#66d9ef">if</span> (theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isShared())
    {
        theString.value <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringValue(theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data);
    }
    theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>markUnshareable(); 
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>(theString.value<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data[charIndex]);
}
</code></pre></div></li>

<li><p>Integrating with templates</p>

<p>If we have a template for reference-counted arrays that use proxy classes to distringuish lvalue and rvalue invocations of operator[]:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">T</span><span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Array</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Proxy</span> {
    <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
        Proxy(Array<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span><span style="color:#f92672">&amp;</span> array, <span style="color:#66d9ef">int</span> index);
        Proxy<span style="color:#f92672">&amp;</span> <span style="color:#66d9ef">operator</span><span style="color:#f92672">=</span>(<span style="color:#66d9ef">const</span> T<span style="color:#f92672">&amp;</span> rhs);
        <span style="color:#66d9ef">operator</span> <span style="color:#a6e22e">T</span>() <span style="color:#66d9ef">const</span>;
        ...
    };
    <span style="color:#66d9ef">const</span> Proxy <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index) <span style="color:#66d9ef">const</span>;
    Proxy <span style="color:#66d9ef">operator</span>[](<span style="color:#66d9ef">int</span> index);
    ...
};
</code></pre></div>
<p>Then for <code>Array&lt;int&gt; intArray;</code>, we can&rsquo;t make statement such as <code>intArray[5] += 5;</code> or <code>++intArray[5];</code>, since <code>operator+=</code> and <code>operator++</code> is not defined for proxy objects. To solve this problem, we have to define each of these functions for the <code>Array&lt;T&gt;::Proxy</code>, which, unfortunately, is a lot of work.</p>

<p>Similarly, we can&rsquo;t invoke member functions on real objects through  proxies. For an array taking <code>Rational</code> as elements (<code>Array&lt;Rational&gt; array;</code>), there is no way to invoke <code>Rational</code>&rsquo;s member function like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">cout <span style="color:#f92672">&lt;</span><span style="color:#f92672">&lt;</span> array[<span style="color:#ae81ff">4</span>].numerator();  <span style="color:#75715e">// error!
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> denom <span style="color:#f92672">=</span> array[<span style="color:#ae81ff">22</span>].denominator();  <span style="color:#75715e">// error!
</span></code></pre></div>
<p>The solution is similar: we need to overload these functions so that they also apply to proxies.</p></li>

<li><p>Passed to functions taking references to non-const objects</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">swap</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">&amp;</span> a, <span style="color:#66d9ef">char</span><span style="color:#f92672">&amp;</span> b);
String s <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">+C+</span><span style="color:#e6db74">&#34;</span>;
swap(s[<span style="color:#ae81ff">0</span>], s[<span style="color:#ae81ff">1</span>]);  <span style="color:#75715e">// won&#39;t compile
</span></code></pre></div>
<p>A <code>CharProxy</code> may be implicitly converted into a <code>char</code>, but there is no conversion function to a <code>char&amp;</code>. Further more, the <code>char</code> to which it may be converted can&rsquo;t be bound to swap&rsquo;s <code>char&amp;</code> parameters, because that <code>char</code> is a temporary object (<code>operator char</code> returns by value,) and, as MECpp item 19 explains, temporary objects are refused to be bound to non-const reference parameters.</p></li>

<li><p>Implicit type conversions</p>

<p>The process where a proxy object implicitly converted into the real object it stands for, a user-defined conversion function is invoked. As MECpp item 5 explains, only one user-defined conversion function is used by compiler when implicitly converting a parameter at a call site into the type needed by the corresponding function parameter.</p></li>
</ol>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://nianze.tk/tags/technique/">technique</a>

  <a class="tag tag--primary tag--small" href="https://nianze.tk/tags/cpp/">cpp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://nianze.tk/2018/05/making-functions-virtual-with-respect-to-more-than-one-object/" data-tooltip="[MECpp]Item-31 Making Functions Virtual With Respect to More Than One Object">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://nianze.tk/2018/05/reference-counting/" data-tooltip="[MECpp]Item-29 Reference Counting">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://nianze.tk/2018/05/proxy-classes/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://nianze.tk/2018/05/proxy-classes/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://nianze.tk/2018/05/proxy-classes/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="utteranc_thread">
  <script src="https://utteranc.es/client.js"
    repo= "Nianze/personal-site-comments"
    issue-term="pathname"
    theme="github-light"
    label="‚ú®comment üí¨"
    crossorigin="anonymous"
    async>
  </script>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 ÂàÄÂøÉ„ÅÆÊ∞¥. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://nianze.tk/2018/05/making-functions-virtual-with-respect-to-more-than-one-object/" data-tooltip="[MECpp]Item-31 Making Functions Virtual With Respect to More Than One Object">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://nianze.tk/2018/05/reference-counting/" data-tooltip="[MECpp]Item-29 Reference Counting">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://nianze.tk/2018/05/proxy-classes/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://nianze.tk/2018/05/proxy-classes/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://nianze.tk/2018/05/proxy-classes/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fas fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fnianze.tk%2F2018%2F05%2Fproxy-classes%2F">
          <i class="fa fa-facebook-f"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fnianze.tk%2F2018%2F05%2Fproxy-classes%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fnianze.tk%2F2018%2F05%2Fproxy-classes%2F">
          <i class="fa fa-google-plus-g"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fas fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">ÂàÄÂøÉ„ÅÆÊ∞¥</h4>
    
      <div id="about-card-bio"><p>ËôöÂ∫¶Âªø‰ΩôÂ≤ÅÊúàÊµÖÔºåÁï•ËØÜÂá†Ë°å‰ª£Á†ÅÊ∫ê„ÄÇ<br />
Èó≤Êù•ÈöèÊâãÂø´Èó®ÊåâÔºåÊÄÜÁÑ∂Áã¨ÊääÈü≥ÈüµÂºπ„ÄÇ</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</div>
    
    
      <div id="about-card-job">
        <i class="fas fa-laptop-code"></i>
        <br/>
        Developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fas fa-map-marked-alt"></i>
        <br/>
        New York
      </div>
    
  </div>
</div>

    

    
  
    
    <div id="cover" style="background-image:url('https://nianze.tk/images/road.JPG');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.2.0/imagesloaded.pkgd.min.js"></script>


<script src="https://nianze.tk/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


  
    <script src="https://nianze.tk/js/loader.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>





    
  </body>
</html>

