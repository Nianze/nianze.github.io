<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="author" content="ÂàÄÂøÉ„ÅÆÊ∞¥">
<meta name="keywords" content=", visual, music, technology">
<meta name="description" content="Templates generate multiple classes and multiple functions, so any template code not dependent on a template parameter (either non-type template parameters or type parameters) causes bloat: eliminate bloat due to non-type template parameters by replacing template parameters with function parameters or class data members; reduce bloat caused from type parameters by sharing implementations for instantiation types with identical binary representations.">


<meta property="og:description" content="Templates generate multiple classes and multiple functions, so any template code not dependent on a template parameter (either non-type template parameters or type parameters) causes bloat: eliminate bloat due to non-type template parameters by replacing template parameters with function parameters or class data members; reduce bloat caused from type parameters by sharing implementations for instantiation types with identical binary representations.">
<meta property="og:type" content="article">
<meta property="og:title" content="Item-44 Factor parameter-independent code out of templates">
<meta name="twitter:title" content="Item-44 Factor parameter-independent code out of templates">
<meta property="og:url" content="http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
<meta property="twitter:url" content="http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
<meta property="og:site_name" content="Be creative">
<meta property="og:description" content="Templates generate multiple classes and multiple functions, so any template code not dependent on a template parameter (either non-type template parameters or type parameters) causes bloat: eliminate bloat due to non-type template parameters by replacing template parameters with function parameters or class data members; reduce bloat caused from type parameters by sharing implementations for instantiation types with identical binary representations.">
<meta name="twitter:description" content="Templates generate multiple classes and multiple functions, so any template code not dependent on a template parameter (either non-type template parameters or type parameters) causes bloat: eliminate bloat due to non-type template parameters by replacing template parameters with function parameters or class data members; reduce bloat caused from type parameters by sharing implementations for instantiation types with identical binary representations.">
<meta property="og:locale" content="en-us">

  
    <meta property="article:published_time" content="2018-03-10T20:24:42">
  
  
    <meta property="article:modified_time" content="2018-03-10T20:24:42">
  
  
  
    
      <meta property="article:section" content="technology">
    
      <meta property="article:section" content="coding">
    
  
  
    
      <meta property="article:tag" content="technique">
    
      <meta property="article:tag" content="cpp">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="http://nianze.tk/images/2018/2018-03/2018-03-10.gif">
  <meta property="twitter:image" content="http://nianze.tk/images/2018/2018-03/2018-03-10.gif">





  <meta property="og:image" content="http://nianze.tk/images/bw.JPG">
  <meta property="twitter:image" content="http://nianze.tk/images/bw.JPG">


    <title>Item-44 Factor parameter-independent code out of templates</title>

    <link rel="icon" href="http://nianze.tk/favicon.png">
    

    

    <link rel="canonical" href="http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">

    
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="http://nianze.tk/css/style-nnm2spxvve8onlujjlegkkytaehyadd4ksxc1hyzzq9a2wvtrgbljqyulomn.min.css" />
    
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/main.css">
      
    
      
        <link rel="stylesheet" href="http://nianze.tk/css/loader.css">
      
    

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-71584380-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
    
  </head>

  <body id="container">
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fas fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="http://nianze.tk/">Be creative</a>
  </div>
  
    
      <a class="header-right-picture "
         href="http://nianze.tk/#about">
    
    
    
      
        <img class="header-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="http://nianze.tk/#about">
          <img class="sidebar-profile-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">ÂàÄÂøÉ„ÅÆÊ∞¥</h4>
        
          <h5 class="sidebar-profile-bio"><p>ËôöÂ∫¶Âªø‰ΩôÂ≤ÅÊúàÊµÖÔºåÁï•ËØÜÂá†Ë°å‰ª£Á†ÅÊ∫ê„ÄÇ<br />
Èó≤Êù•ÈöèÊâãÂø´Èó®ÊåâÔºåÊÄÜÁÑ∂Áã¨ÊääÈü≥ÈüµÂºπ„ÄÇ</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/">
    
      <i class="sidebar-button-icon fas fa-home" title='Home'></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/thoughts">
    
      <i class="sidebar-button-icon fas fa-lightbulb" title='Thoughts'></i>
      
      <span class="sidebar-button-desc">Thoughts</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/technology">
    
      <i class="sidebar-button-icon fas fa-code" title='Technology'></i>
      
      <span class="sidebar-button-desc">Technology</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/music">
    
      <i class="sidebar-button-icon fas fa-music" title='Music'></i>
      
      <span class="sidebar-button-desc">Music</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories/visual">
    
      <i class="sidebar-button-icon fas fa-palette" title='Visual'></i>
      
      <span class="sidebar-button-desc">Visual</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/categories">
    
      <i class="sidebar-button-icon fas fa-bookmark" title='Categories'></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/tags">
    
      <i class="sidebar-button-icon fas fa-tags" title='Tags'></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/archives">
    
      <i class="sidebar-button-icon fas fa-archive" title='Archives'></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/about">
    
      <i class="sidebar-button-icon fas fa-user" title='About'></i>
      
      <span class="sidebar-button-desc">About</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.linkedin.com/in/nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-linkedin" title='LinkedIn'></i>
      
      <span class="sidebar-button-desc">LinkedIn</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/Nianze" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-github" title='Github'></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.flickr.com/photos/129774362@N07/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-flickr", title='Flickr'></i>
      
      <span class="sidebar-button-desc">Flickr</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://instagram.com/eznain" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-instagram" title='Instagram'></i>
      
      <span class="sidebar-button-desc">Instagram</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.facebook.com/rym.lnz" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-facebook", title='Facebook'></i>
      
      <span class="sidebar-button-desc">Facebook</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-twitter", title='Twitter'></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://www.youtube.com/user/daoxinzhishui" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fab fa-youtube", title='YouTube'></i>
      
      <span class="sidebar-button-desc">YouTube</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="mailto:daoxinzhishui@gmail.com" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fas fa-envelope", title='Email'></i>
      
      <span class="sidebar-button-desc">Email</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="http://nianze.tk/post/index.xml">
    
      <i class="sidebar-button-icon fas fa-rss-square", title='RSS'></i>
      
      <span class="sidebar-button-desc">RSS</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Item-44 Factor parameter-independent code out of templates
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2018-03-10T20:24:42-05:00">
        
  March 10, 2018

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="http://nianze.tk/categories/technology">technology</a>, 
    
      <a class="category-link" href="http://nianze.tk/categories/coding">coding</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Templates generate multiple classes and multiple functions, so any template code not dependent on a template parameter (either non-type template parameters or type parameters) causes bloat: eliminate bloat due to non-type template parameters by replacing template parameters with function parameters or class data members; reduce bloat caused from type parameters by sharing implementations for instantiation types with identical binary representations.</p>

<h1 id="table-of-contents">Table of Contents</h1><nav id="TableOfContents">
<ul>
<li><a href="#bloat-due-to-non-type-template-parameters">Bloat due to non-type template parameters</a>
<ul>
<li><a href="#replace-with-function-parameters">Replace with function parameters</a></li>
<li><a href="#replace-with-class-data-members">Replace with class data members</a></li>
<li><a href="#efficiency-concerns">Efficiency concerns</a></li>
<li><a href="#other-trade-offs">Other trade-offs</a></li>
</ul></li>
<li><a href="#bloat-due-to-type-parameters">Bloat due to type parameters</a></li>
</ul>
</nav>

<p>When writing templates, since there&rsquo;s only one copy of the template source code, we have to analyze it carefully to avoid the implicit replication that may take place when a template is instantiated multiple times.</p>

<h1 id="bloat-due-to-non-type-template-parameters">Bloat due to non-type template parameters</h1>

<p>For example, suppose we&rsquo;d like to write a template for fixed-size square matrices that support matrix inversion:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_t n<span style="color:#f92672">&gt;</span>  <span style="color:#75715e">// template for n*n matrices of obejcts of type T
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SquareMatrix</span>{
pubic:
    <span style="color:#66d9ef">void</span> invert();  <span style="color:#75715e">// invert the matrix in place
</span><span style="color:#75715e"></span>    ...
};
</code></pre></div>
<p>This template takes a type parameter <code>T</code> as well as a <em>non-type parameter</em> <code>n</code> of type <code>size_t</code>. This example is actually a classic way for template-induced code bloat:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">SquareMatrix<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">double</span>, <span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span> sm1;
sm1.invert();  <span style="color:#75715e">// call SquareMatrix&lt;double, 5&gt;::invert
</span><span style="color:#75715e"></span>SquareMatrix<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">double</span>, <span style="color:#ae81ff">10</span><span style="color:#f92672">&gt;</span> sm2;
sm2.invert();  <span style="color:#75715e">// call SquareMatrix&lt;double, 10&gt;::invert
</span></code></pre></div>
<p>In the statements above, two copies of <code>invert</code> will be instantiated, and these two version of <code>invert</code> are character-for-character identical except for the use of 5 in one version and 10 in the other. To reduce the code bloat, we could redesign and call a parameterized function instead.</p>

<h2 id="replace-with-function-parameters">Replace with function parameters</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>     <span style="color:#75715e">// size-independent base class for square matrices
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SquareMatrixBase</span>{  <span style="color:#75715e">// all matrices holding a givin type of object will share a single base class with a single copy of this base class&#39;s version of invert
</span><span style="color:#75715e"></span><span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span> 
    <span style="color:#75715e">// intend only to be a way for derived classes to avoid code replication, so declared as protected instaend of public
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> invert(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_t matrixSize); <span style="color:#75715e">// invert matrix of the given size
</span><span style="color:#75715e"></span>    ...
};

<span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_t n<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SqureMatrix</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">private</span> SquareMatrixBase<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> { <span style="color:#75715e">// not a is-a relationship, using private inheritance only for base class implementation, item 39
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">using</span> SquareMatrixBase<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span><span style="color:#f92672">:</span><span style="color:#f92672">:</span>invert;  <span style="color:#75715e">// avoid hiding base version of invert, item 33
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    ...                                 <span style="color:#75715e">// make inline call to base class version of invert:
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> invert() { <span style="color:#66d9ef">this</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>invert(n); }  <span style="color:#75715e">// 1. it&#39;s implicit inline, so there&#39;s no addictional cost of calling it, item 30
</span><span style="color:#75715e"></span>    ...                                 <span style="color:#75715e">// 2. use &#34;this-&gt;&#34; so that function names in templatized base classes are revealed in derived classes, item 43
</span><span style="color:#75715e"></span>};
</code></pre></div>
<p>This design addressed the issue of code bloat, but it also introduces a problem: <code>SquareMatrixBase::invert</code> only knows the size of the data, but it does not know where the data for a particular matrix is, because only the derived class knows that. We could add another parameter to <code>SquareMatrixBase::invert</code>, such as a pointer to the beginning of a chunk of memory that stores the matrix&rsquo;s data.</p>

<p>However, an alternative and possibly better solution will be to have <code>SquareMatrixBase</code> store both a pointer to the memory for the matrix values, as well as the matrix size, so that any other functions asking for the matrix memory address or matrix size can be written in a address-independent-and-size-independent manner, and moved into <code>SquareMatrixBase</code>.</p>

<h2 id="replace-with-class-data-members">Replace with class data members</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SquareMatrixBase</span> {
<span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
    SquareMatrixBase(std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_t n, T <span style="color:#f92672">*</span>pMem)  <span style="color:#75715e">// store matrix size and a ptr to matrix values
</span><span style="color:#75715e"></span>    <span style="color:#f92672">:</span> size(n), pData(pMem) {}
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setDataPtr</span>(T <span style="color:#f92672">*</span>ptr) { pData <span style="color:#f92672">=</span> ptr; }  <span style="color:#75715e">// reassign pData
</span><span style="color:#75715e"></span>    ...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_t size;  <span style="color:#75715e">// size of matrix
</span><span style="color:#75715e"></span>    T <span style="color:#f92672">*</span>pData;  <span style="color:#75715e">// pointer to matrix values
</span><span style="color:#75715e"></span>};
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_t n<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SquareMatrix</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">private</span> SqureMatrixBase<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    SquareMatrix()  <span style="color:#75715e">// send matrix size and data ptr to base class
</span><span style="color:#75715e"></span>    <span style="color:#f92672">:</span> SquareMatrixBase<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(n, data) {} 
    ...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    T data[n<span style="color:#f92672">*</span>n];
};
</code></pre></div>
<p>Objects of such type have no need for dynamic memory allocation, but the objects could be very large. An alternative would be to put the data for each matrix on the heap:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T, std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>size_t n<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SquareMatrix</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">private</span> SqureMatrixBase<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    SquareMatrix()  
    <span style="color:#f92672">:</span> SquareMatrixBase<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(n, <span style="color:#ae81ff">0</span>),         <span style="color:#75715e">// set base class ptr to null
</span><span style="color:#75715e"></span>      pData(<span style="color:#66d9ef">new</span> T[n<span style="color:#f92672">*</span>n])                  <span style="color:#75715e">// allocate memory for matrix values and save a ptr to the memory
</span><span style="color:#75715e"></span>    { <span style="color:#66d9ef">this</span><span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setDataPtr(pData.get()); }   <span style="color:#75715e">// give a copy of the ptr to the base class
</span><span style="color:#75715e"></span>    ...
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    boost<span style="color:#f92672">:</span><span style="color:#f92672">:</span>scoped_array<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> pData;  <span style="color:#75715e">// see item 13 for info on boost::scoped_array
</span><span style="color:#75715e"></span>};
</code></pre></div>
<p>No matter where the matrix value data is stored, the result from a bloat point of view is that many <code>SquareMatrix</code>&rsquo;s member functions can be simple inline calls to base class versions that are shared with all other matrices holding the same type of data, regardless of their size.</p>

<h2 id="efficiency-concerns">Efficiency concerns</h2>

<p>In terms of efficiency, it is possible that the version of <code>invert</code> with the matrix sizes hardwired into them generates better code than the shared version whose size is passed as a function parameter or is stored in the object: in the size-specific versions, the sizes would be compile-time constants, hence eligible for optimizations such as constant propagation (they&rsquo;ll be folded into the generated instructions as imeediate operands), which can&rsquo;t be done in the size-independent version.</p>

<p>On the other side, the size-independent version decreases the size of executable by having only one version of <code>invert</code> for multiple matrix sizes, and this could reduce the program&rsquo;s working set size and improve locality of reference in the instruction cache, which may in term compensating for any lost optimizations in size-specific versions of <code>invert</code>. The only way to tell which version is better one is to try them both and observe the behavior on the particular platform and on representative data sets.</p>

<h2 id="other-trade-offs">Other trade-offs</h2>

<p>Speaking of size of objects, we should observe that there&rsquo;s an extra size of a pointer in each <code>SquareMatrix</code> object, because, as the derived class, <code>SquareMatrix</code> could get to the data by alternative designs such as having the base class store a <code>protected</code> pointer to the matrix data. However, this new design also has some disadvantages:</p>

<ol>
<li>it may lead to the loss of encapsulation described in item 22</li>
<li>it may also lead to resource management complications: since derived class may either dynamically alloacate the matrix data, or physically store the data inside the derived class object, if we only let the base class store a pointer to that data, it is hard for base class to determine whether the pointer should be deleted or not.</li>
</ol>

<p>At some point, a little code replication seems like a mercy to keep away from complication.</p>

<h1 id="bloat-due-to-type-parameters">Bloat due to type parameters</h1>

<p>On many platforms, <code>int</code> and <code>long</code> have the same binary representation, so the member functions for <code>vector&lt;int&gt;</code> and <code>vector&lt;long&gt;</code> would likely be identical. Some linkers will merge identical function implementations, but some will not, and that means that some templates instantiated on both <code>int</code> and <code>long</code> could cause code bloat in some environments.</p>

<p>Similarly, on most platforms, all pointer types have the same binary representation, so templates holding pointer types (e.g., <code>list&lt;int*&gt;</code>, <code>list&lt;const int*&gt;</code>, <code>list&lt;SquareMatrix&lt;long, 3&gt;*&gt;</code>, etc.) should be able to use a single underlying implementation for each member function. Typically, this is achieved by implementing member functions that work with strongly typed pointers (i.e., <code>T*</code> pointers) by having them call functions that work with untyped pointers (i.e., <code>void*</code> pointers), which is how some of standart C++ library do for templates like <code>vector</code>, <code>deque</code>, and <code>list</code>.</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/technique/">technique</a>

  <a class="tag tag--primary tag--small" href="http://nianze.tk/tags/cpp/">cpp</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/03/use-member-function-templates-to-accept-all-compatible-types/" data-tooltip="Item-45 Use member function templates to accept all compatible types">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/03/know-how-to-access-names-in-templatized-base-classes/" data-tooltip="Item-43 Know how to access names in templatized base classes">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="utteranc_thread">
  <script src="https://utteranc.es/client.js"
    repo= "Nianze/personal-site-comments"
    issue-term="pathname"
    theme="github-light"
    label="‚ú®comment üí¨"
    crossorigin="anonymous"
    async>
  </script>
</div>
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2019 ÂàÄÂøÉ„ÅÆÊ∞¥. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/03/use-member-function-templates-to-accept-all-compatible-types/" data-tooltip="Item-45 Use member function templates to accept all compatible types">
              
                  <i class="fas fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="http://nianze.tk/2018/03/know-how-to-access-names-in-templatized-base-classes/" data-tooltip="Item-43 Know how to access names in templatized base classes">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fas fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fas fa-share-alt"></i>
          </a>
        </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
              <i class="fab fa-facebook-f"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
        
          <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://nianze.tk/2018/03/factor-parameter-independent-code-out-of-templates/">
              <i class="fab fa-google-plus-g"></i>
            </a>
          </li>
        
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#utteranc_thread" data-tooltip="Comments">
            <i class="fas fa-comment-dots"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#table-of-contents" data-tooltip="Table of Contents">
            <i class="fas fa-list"></i>
        
          </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fas fa-times"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fnianze.tk%2F2018%2F03%2Ffactor-parameter-independent-code-out-of-templates%2F">
          <i class="fa fa-facebook-f"></i><span>Share on Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http%3A%2F%2Fnianze.tk%2F2018%2F03%2Ffactor-parameter-independent-code-out-of-templates%2F">
          <i class="fa fa-twitter"></i><span>Share on Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http%3A%2F%2Fnianze.tk%2F2018%2F03%2Ffactor-parameter-independent-code-out-of-templates%2F">
          <i class="fa fa-google-plus-g"></i><span>Share on Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fas fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="http://nianze.tk/images/bw.JPG" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">ÂàÄÂøÉ„ÅÆÊ∞¥</h4>
    
      <div id="about-card-bio"><p>ËôöÂ∫¶Âªø‰ΩôÂ≤ÅÊúàÊµÖÔºåÁï•ËØÜÂá†Ë°å‰ª£Á†ÅÊ∫ê„ÄÇ<br />
Èó≤Êù•ÈöèÊâãÂø´Èó®ÊåâÔºåÊÄÜÁÑ∂Áã¨ÊääÈü≥ÈüµÂºπ„ÄÇ</p>

<p>Pain is inevitable.<br />
Suffering is optional.</p>
</div>
    
    
      <div id="about-card-job">
        <i class="fas fa-laptop-code"></i>
        <br/>
        Developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fas fa-map-marked-alt"></i>
        <br/>
        New York
      </div>
    
  </div>
</div>

    

    
  
    
      
      <div id="cover" style="background-image:url('http://nianze.tk/images/reservoir.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.2.0/imagesloaded.pkgd.min.js"></script>


<script src="http://nianze.tk/js/script-qi9wbxp2ya2j6p7wx1i6tgavftewndznf4v0hy2gvivk1rxgc3lm7njqb6bz.min.js"></script>


  
    <script src="http://nianze.tk/js/loader.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>





    
  </body>
</html>

